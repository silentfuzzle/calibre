  <!DOCTYPE html> 
  <meta charset="utf-8">
  <body> 
 <style> 
.link {
fill: none;
stroke: #666;
opacity: 0.6;
stroke-width: 1.5px; 
} 
.node circle { 
stroke: #fff; 
opacity: 0.6;
stroke-width: 1.5px; 
} 
text { 
font: 7px serif; 
opacity: 0.6;
pointer-events: none; 
} 
</style> 

<script src=d3.v3.min.js></script>

<script> 
/*
 * images management
 * Copyright 2014 Emily Palmieri <silentfuzzle@gmail.com>
 * License: GNU GPL v3
 */

//d3.json("eBookGraph.json", dataLoaded)

var width = 500
height = 500;
    
// Set the viewer window to fill the TOC panel
var svg = d3.select("body")
    .append("svg")
      .attr({
        "width": "100%",
        "height": "100%"
      })
      .attr("viewBox", "0 0 " + width + " " + height )
      .attr("preserveAspectRatio", "xMidYMid meet")
      .attr("pointer-events", "all")
    .call(d3.behavior.zoom().on("zoom", redraw));
    
var vis;
var currPage = -1;
var node;
var link;

///////////////////////////////////////////////////////////////////////////////
//CALLED FROM PYTHON
///////////////////////////////////////////////////////////////////////////////

// Display a network from passed JSON data
// data (string) - json code
// pageNum (float) - the number of the first page of the section the user is currently viewing
function dataLoaded(data, pageNum) {
    var links = data.links
    var nodes = data.nodes
        
    // Set the links to point to node objects
    links.forEach(function(link) {
        link.source = nodes[link.source] || (nodes[link.source] = {name: link.source});
        link.target = nodes[link.target] || (nodes[link.target] = {name: link.target});
        link.value = +link.value;
    });

    // Set the type of network to display and its parameters
    var force = d3.layout.force() 
        .nodes(d3.values(nodes)) 
        .links(links) 
        .size([width, height]) 
        .linkDistance(50) 
        .charge(-200) 
        .on("tick", tick) 
        .start(); 
        
    // Clear any old network data from previous renderings
    d3.selectAll("svg > *").remove();

    // Reset the variables for displaying links as arrows
    svg.append("defs").selectAll("marker")
        .data(["suit"])
      .enter().append("marker")
        .attr("id", function(d) { return d; })
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 15)
        .attr("refY", -1.5)
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
      .append("path")
        .attr("d", "M0,-5L10,0L0,5");
    
    vis = svg.append('svg:g');
    
    // Create an object that stores all links added to the network
    // "marker-end" - used for displaying links as arrows
    // .style - used for resizing the links as the user zooms in or out of the network
    link = vis.selectAll("path")
        .data(force.links())
      .enter().append("path")
        .attr("class", "link")
        .attr("marker-end", "url(#suit)")
        .style("stroke-width", function(d) { return Math.sqrt(d.value); });
    
    // Create an object that stores all the nodes added to the network
    node = vis.selectAll(".node") 
        .data(force.nodes()) 
        .enter().append("g") 
        .attr("class", "node") 
        .on("mouseover", mouseover) 
        .on("mouseout", mouseout) 
        .on("click", click)
        .on("dblclick", dblclick)
        .call(force.drag); 

    // Set the appearance of the node to be a circle
    node.append("circle") 
        .attr("r", 8)

    // Set the text appearing next to the node and other data the node stores
    node.append("text") 
        .attr("x", 12) 
        .attr("dy", ".35em") 
        .attr("page", function(d) { return d.id; })
        .style("fill", "#000000")
        .text(function(d) { return d.title; });
        
    // Set the color of the nodes
    changePage(pageNum);
}

// Set the color of the nodes
// pageNum (float) - the number of the first page of the section the user is currently viewing
function changePage(pageNum) {
    currPage = pageNum;
    node.select("circle").style("fill", fillNode);
}

///////////////////////////////////////////////////////////////////////////////
//DRAW METHODS
///////////////////////////////////////////////////////////////////////////////

// Color a node in the network
// d - a node object pulled from the svg
function fillNode(d) {
    if (d.id == currPage) { 
        // Color the node of the section the user is currently viewing a different color
        return "#555555"; 
    } 
    else { 
        return "#3182bd"; 
    }
}

// Draws a directed link between nodes
// d - a link object pulled from the svg
function drawCurve(d) {
    var dx = d.target.x - d.source.x,
      dy = d.target.y - d.source.y,
      dr = Math.sqrt(dx * dx + dy * dy);
    return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
}
    
// Animates the force-directed network
function tick() { 
    link.attr("d", drawCurve);
    node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; }); 
}

// Scales and pans the network as specified by the user
function redraw() {
  vis.attr("transform",
      "translate(" + d3.event.translate + ")"
      + " scale(" + d3.event.scale + ")");
}

///////////////////////////////////////////////////////////////////////////////
//EVENTS
///////////////////////////////////////////////////////////////////////////////

// Calls Python to send the user to the section corresponding to the node clicked in the viewer
function click() {
    // Get the first page number of the section from the node that was clicked
    pageNum = d3.select(this).select("text").attr("page");
    
    // Call the Python code
    container.change_page(pageNum);
}

function mouseover() { 
    d3.select(this).select("text").transition()
    .duration(750)
    .attr("x", 22)
    .style("stroke-width", ".5px")
    .style("opacity", 1)
    .style("font", "17.5px serif");
    d3.select(this).select("circle").transition() 
    .duration(750) 
    .attr("r", 16); 
} 

function mouseout() { 
    d3.select(this).select("circle").transition() 
    .duration(750) 
    .attr("r", 8); 
    d3.select(this).select("text").transition()
    .duration(750)
    .attr("x", 12)
    .style("stroke", "none")
    .style("stroke", "none")
    .style("opacity", 0.6)
    .style("font", "7px serif");
} 

// action to take on mouse double click
function dblclick() {
    d3.select(this).select("circle").transition()
    .duration(750)
    .attr("r", 6);
}

</script>
 </body>