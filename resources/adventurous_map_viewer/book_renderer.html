  <!DOCTYPE html> 
  <meta charset="utf-8">
  <body> 
 <style> 
.link {
fill: none;
stroke: #666;
opacity: 0.6;
stroke-width: 1.5px; 
} 
.node circle { 
stroke: #fff; 
opacity: 0.6;
stroke-width: 1.5px; 
} 
text { 
font: 7px serif; 
opacity: 1;
pointer-events: none; 
}
</style> 

<script src=d3.v3.min.js></script>

<script> 
/*
 * images management
 * Copyright 2014 Emily Palmieri <silentfuzzle@gmail.com>
 * License: GNU GPL v3
 */

//d3.json("eBookGraph.json", dataLoaded)

var width = 500
height = 500;

var textDefaultXOffset = 12;
var textDefaultOpacity = 0.6;

var nodeDefaultRadius = 8;
var arrowOffset = 10;
    
var vis;
var force;
var currPage = -1;
var node = 0;
var link;
  
// Set the viewer window to fill the TOC panel
var svg = d3.select("body")
    .append("svg")
      .attr({
        "width": "100%",
        "height": "100%"
      })
      .attr("preserveAspectRatio", "xMidYMid meet")
      .attr("pointer-events", "all");

// Controls the zoom and pan functions initiated by the user
var zoomListener = d3.behavior.zoom()
  .scaleExtent([0.1, 3])
  .on("zoom", redraw);
zoomListener(svg);

///////////////////////////////////////////////////////////////////////////////
//CALLED FROM PYTHON
///////////////////////////////////////////////////////////////////////////////

// Display a network from passed JSON data
// data (string) - json code
// pageNum (float) - the number of the first page of the section the user is currently viewing
function dataLoaded(data, pageNum) {
    var links = data.links;
    var nodes = data.nodes;
    
    var nodeDictionary = new Object();
    if (node != 0) {
        // The user has created a new link, prepare to reload the network
        force.stop();
        
        // Save the current node positions in a dictionary
        node.each(function(d) {
            pos = [];
            pos[0] = d.x;
            pos[1] = d.y;
            var page = d.id;
            nodeDictionary[page] = pos;
        });
        
        // Set the initial node positions to the saved positions
        nodes.forEach(function(n) {
            var x = nodeDictionary[n.id][0];
            var y = nodeDictionary[n.id][1];
            n.x = x;
            n.y = y;
        });
    }
        
    // Set the links to point to node objects
    links.forEach(function(link) {
        link.source = nodes[link.source] || (nodes[link.source] = {name: link.source});
        link.target = nodes[link.target] || (nodes[link.target] = {name: link.target});
        link.value = +link.value;
    });

    // Set the type of network to display and its parameters
    force = d3.layout.force() 
        .nodes(nodes) 
        .links(links) 
        .size([width, height]) 
        .linkDistance(50) 
        .charge(-100) 
        .on("tick", tick)
        .start();
        
    // Clear any old network data from previous renderings
    d3.selectAll("svg > *").remove();

    // Reset the variables for displaying links as arrows
    // .append("path") - creates a triangle shape to place at the end of an arrow
    svg.append("defs").selectAll("marker")
        .data(["suit"])
      .enter().append("marker")
        .attr("id", function(d) { return d; })
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", nodeDefaultRadius + arrowOffset)
        .attr("refY", 0)
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
      .append("path")
        .attr("d", "M0,-5L10,0L0,5");
    
    // This group contains all elements of the network
    // Allows users to zoom and pan by manipulating the svg
    vis = svg.append('svg:g');
    
    // Create an object that stores all links added to the network
    // "marker-end" - associates a triangle with a link to create a directed arrow
    // .style - used for resizing the links as the user zooms in or out of the network
    // .attr("class", "link") - sets the .link css attributes to links
    link = vis.selectAll("path")
        .data(force.links())
      .enter().append("path")
        .attr("class", "link")
        .attr("marker-end", "url(#suit)")
        .style("stroke-width", function(d) { return Math.sqrt(d.value); });
    
    // Create an object that stores all the nodes added to the network
    // .attr("class", "node") - sets the .node circle attributes to node circles
    node = vis.selectAll(".node") 
        .data(force.nodes()) 
      .enter().append("g") 
        .attr("class", "node") 
        .attr("page", function(d) { return d.id; })
        .attr("x", function(d) { return d.x; })
        .attr("y", function(d) { return d.y; })
        .on("mouseover", mouseover) 
        .on("mouseout", mouseout) 
        .on("click", click)
        .on("dblclick", dblclick)
        .call(force.drag); 

    // Set the appearance of the node to be a circle
    node.append("circle") 
        .attr("r", nodeDefaultRadius);

    // Set the text appearing next to the node and other data the node stores
    node.append("text") 
        .attr("x", textDefaultXOffset) 
        .attr("dy", ".35em") 
        .style("fill", "#000000")
        .text(function(d) { return d.title; });
    
    // Wrap the text of long titles
    node.selectAll("text")
      .call(wrap, 100);
      
    // Set the opacity of wrapped text
    node.selectAll("text")
    .selectAll('tspan')
    .style("opacity", textDefaultOpacity);
    
    // Set the color of the nodes
    changePage(pageNum);
    
    // Make sure the display is set to the current scale and location
    zoomListener.scale(zoomListener.scale());
    zoomListener.translate(zoomListener.translate());
    zoomListener.event(vis);
}

// Set the color of the nodes
// pageNum (float) - the number of the first page of the section the user is currently viewing
function changePage(pageNum) {
    currPage = pageNum;
    node.select("circle").style("fill", fillNode);
}

///////////////////////////////////////////////////////////////////////////////
//DRAW METHODS
///////////////////////////////////////////////////////////////////////////////

// Wraps the text labeling each node
// text - the text attribute selected from all nodes
// width - the maximum width of a label
function wrap(text, width) {
  text.each(function() {
    var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.1, // ems
        y = 0,
        x = textDefaultXOffset,
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", x).attr("y", y).attr("dy", dy + "em");
    while (word = words.pop()) {
      line.push(word);
      tspan.text(line.join(" "));
      if (tspan.node().getComputedTextLength() > width) {
        line.pop();
        tspan.text(line.join(" "));
        line = [word];
        lineNumber = lineNumber + 1;
        tspan = text.append("tspan").attr("x", x).attr("y", y).attr("dy", lineNumber * lineHeight + dy + "em").text(word);
      }
    }
  });
}

// Color a node in the network
// d - a node object pulled from the svg
function fillNode(d) {
    if (d.id == currPage) { 
        // Color the node of the section the user is currently viewing a different color
        return "#555555"; 
    } 
    else { 
        return "#3182bd"; 
    }
}

// Draws a directed link between nodes
// d - a link object pulled from the svg
function drawCurve(d) {
    // M - move to position
    // L - draw a line from current position to given position
    // See svg path attribute for more information
    return "M" + d.source.x + "," + d.source.y + "L" + d.target.x + "," + d.target.y;
}
    
///////////////////////////////////////////////////////////////////////////////
//POSITION METHODS
///////////////////////////////////////////////////////////////////////////////

// Animates the force-directed network
function tick() { 
    link.attr("d", drawCurve);
    node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
    
    // Update references to the node's position
    node.attr("x", function(d) { return d.x; })
        .attr("y", function(d) { return d.y; });
}

// Scales and pans the network as specified by the user
function redraw() {
  vis.attr("transform",
      "translate(" + d3.event.translate + ")"
      + " scale(" + d3.event.scale + ")");
}

// Centers a node on the screen
// source - an object containing a node svg object
function centerNode(source) {
    scale = zoomListener.scale();
    x1 = d3.select(source).attr("x");
    y1 = d3.select(source).attr("y");
    
    // Center the node at 0 on the svg
    x2 = (width / 2 - x1);
    y2 = (height / 2 - y1);
    
    // Get the screen position of the node at the center of the svg
    var sPos = getScreenCoords(x1, y1, [x2, y2], scale);
    
    // Center the node on the display
    x2 = x2 + (width / 2 - sPos[0]);
    y2 = y2 + (height / 2 - sPos[1]);
    
    // Apply the transformation to the display
    zoomListener.scale(scale);
    zoomListener.translate([x2, y2]);
    zoomListener.event(vis);
}

// Returns the position of the center of a node on the screen
// x - the x-position of a node on the svg
// y - the y-position of a node on the svg
// translate - the transformation required to center the node on the svg
// scale - the current scale of the svg
function getScreenCoords(x, y, translate, scale) {
    var xn = translate[0] + x*scale;
    var yn = translate[1] + y*scale;
    
    return [xn, yn];
}

///////////////////////////////////////////////////////////////////////////////
//EVENTS
///////////////////////////////////////////////////////////////////////////////

// Calls Python to send the user to the section corresponding to the node clicked in the viewer
function click() {        
    centerNode(this);
    
    // Get the first page number of the section from the node that was clicked
    pageNum = d3.select(this).attr("page");
    
    // Call the Python code to change pages
    container.change_page(pageNum);
}

function mouseover() {
    var nodeRadius = 16;
    d3.select(this).select("text").transition()
        .duration(750)
        .selectAll('tspan').attr("x", 22)
        .style("stroke-width", ".5px")
        .style("opacity", 1)
        .style("font", "17.5px serif");
    d3.select(this).select("circle").transition() 
        .duration(750) 
        .attr("r", nodeRadius); 
} 

function mouseout() { 
    d3.select(this).select("circle").transition() 
        .duration(750) 
        .attr("r", nodeDefaultRadius); 
    d3.select(this).select("text").transition()
        .duration(750)
        .selectAll('tspan').attr("x", textDefaultXOffset)
        .style("stroke", "none")
        .style("stroke", "none")
        .style("opacity", textDefaultOpacity)
        .style("font", "7px serif");
} 

// action to take on mouse double click
function dblclick() {
    d3.select(this).select("circle").transition()
    .duration(750)
    .attr("r", 6);
}

</script>
 </body>